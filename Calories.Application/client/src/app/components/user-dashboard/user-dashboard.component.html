<div class="dashboard-container">
  <h2>Welcome {{ user?.userName || "anonymous" }}</h2>
  <h3>Daily target: {{ user?.expectedCaloriesPerDay || 0 }}kcal</h3>
  @if (isFiltered()) {
  <div class="calories-display neutral">
    <h3>Filtered calories: {{ filteredCalories() }}kcal</h3>
  </div>
  } @else {
  <div class="calories-display" [ngClass]="getCaloriesStatus()">
    <h3>Calories today: {{ totalCalories() }}kcal</h3>
    <p class="calories-info">
      @if (getCaloriesStatus() === 'under') { Within daily target } @else if
      (getCaloriesStatus() === 'over') { Above daily target }
    </p>
  </div>
  }

  <div class="actions">
    <button (click)="openCreateMealModal()" class="main-btn">Add Meal</button>
  </div>

  <div class="filter-container">
    <div class="filter-header">
      <h4 class="filter-title">Filter Meals</h4>
      @if (hasActiveFilters()) {
      <button class="main-btn" (click)="clearFilters()">Clear Filters</button>
      }
    </div>

    <div class="filter-groups">
      <div class="filter-group">
        <label for="fromDate">From Date</label>
        <input
          type="date"
          id="fromDate"
          [(ngModel)]="filter.fromDate"
          (ngModelChange)="loadMeals()"
        />
      </div>

      <div class="filter-group">
        <label for="toDate">To Date</label>
        <input
          type="date"
          id="toDate"
          [(ngModel)]="filter.toDate"
          (ngModelChange)="loadMeals()"
        />
      </div>

      <div class="filter-group">
        <label for="fromTime">From Time</label>
        <input
          type="time"
          id="fromTime"
          [(ngModel)]="filter.fromTime"
          (ngModelChange)="loadMeals()"
        />
      </div>

      <div class="filter-group">
        <label for="toTime">To Time</label>
        <input
          type="time"
          id="toTime"
          [(ngModel)]="filter.toTime"
          (ngModelChange)="loadMeals()"
        />
      </div>
    </div>
  </div>

  <app-meals-list
    [meals]="meals()"
    (deleteMeal)="deleteMeal($event)"
  ></app-meals-list>
</div>

@if (isModalOpen) {
<div class="modal">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Add Meal</h3>
    <form #createForm="ngForm" (ngSubmit)="saveCreateMeal()">
      <div class="form-group">
        <label for="desc">Meal description</label>
        <input
          type="text"
          name="desc"
          id="createDesc"
          [(ngModel)]="mealModel.mealDescription"
          #description="ngModel"
          required
        />
        @if (description.invalid && description.touched) {
        <div class="error">
          @if(description.errors?.['required']){
          <span>Meal description field is required</span>
          }
        </div>
        }
      </div>

      <div class="form-group">
        <label for="cals">Meal calories</label>
        <input
          type="number"
          name="cals"
          id="createCals"
          [(ngModel)]="mealModel.mealCalories"
          #calories="ngModel"
          required
          min="1"
        />
        @if (calories.invalid && calories.touched) {
        <div class="error">
          @if(calories.errors?.['required']){
          <span>Meal calories field is required</span>
          } @else if(calories.errors?.['min']){
          <span>Meal should have at least 1 calorie</span>
          }
        </div>
        }
      </div>
      <div class="form-group">
        <label for="date">Meal Date</label>
        <input
          type="date"
          name="date"
          id="createDate"
          [(ngModel)]="mealModel.mealDate"
          #date="ngModel"
          required
        />
        @if (date.invalid && date.touched) {
        <div class="error">
          @if(date.errors?.['required']){
          <span>Meal date field is required</span>
          }
        </div>
        }
      </div>
      <div class="form-group">
        <label for="time">Meal Time</label>
        <input
          type="time"
          name="time"
          id="createTime"
          [(ngModel)]="mealModel.mealTime"
          #time="ngModel"
          required
        />
        @if (time.invalid && time.touched) {
        <div class="error">
          @if(time.errors?.['required']){
          <span>Meal time field is required</span>
          }
        </div>
        }
      </div>

      <div class="modal-actions">
        <button type="submit" class="main-btn" [disabled]="createForm.invalid">
          Add
        </button>
        <button
          type="button"
          class="secondary-btn"
          (click)="closeCreateMealModal()"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
}
